<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor App</title>
    <style>
        :root {
            /* Core Colors from Image Re-evaluation */
            --control-red: #FF5F57;
            --control-yellow: #FEBC2E;
            --control-green: #28C840;

            --app-bg: #F0F0F0; /* Background for the page, to contrast app */
            --app-shell-bg: #252526; /* Overall app background, similar to title bar */
            
            --title-bar-bg: #252526;
            --status-bar-bg: #252526;

            --tab-bar-bg: #333333;
            --active-tab-bg: #1E1E1E; /* Editor background */
            --inactive-tab-bg: #2D2D2D; /* Slightly darker than tab bar for depth */
            
            --editor-bg: #1E1E1E;
            --gutter-bg: #1E1E1E; /* Line numbers background */
            
            /* Text & Icon Colors */
            --text-color-primary: #E0E0E0; /* Brighter text (active tabs, Canda) */
            --text-color-secondary: #9E9E9E; /* Dimmer text (inactive tabs, some icons) */
            --icon-color-primary: #D1D1D1; /* Main icons in title/status bar */
            --icon-color-secondary: #8E8E8E; /* Icons in inactive tabs */
            --icon-hover-color: #FFFFFF;

            --line-number-color: #858585;
            --canda-green-dot: var(--control-green);

            /* Syntax Highlight Colors (Customized) */
            --lua-string-color: #4EC9B0; /* Bright Green/Teal for Lua strings */

            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --editor-font-family: "Consolas", "Courier New", monospace;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--app-bg);
            display: flex; /* For centering app-shell */
            align-items: center; /* For centering app-shell */
            justify-content: center; /* For centering app-shell */
            min-height: 100vh;
        }

        .app-shell {
            width: 1000px;
            height: 700px;
            background-color: var(--app-shell-bg);
            border-radius: 8px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.25), 0 6px 6px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .app-container { /* Renamed inner container */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--editor-bg);
            color: var(--text-color-primary);
        }

        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--title-bar-bg);
            padding: 9px 12px; /* Adjusted padding */
            height: 26px; 
            flex-shrink: 0;
        }

        .window-controls { display: flex; gap: 8px; }
        .control-dot { width: 12px; height: 12px; border-radius: 50%; }
        .red { background-color: var(--control-red); }
        .yellow { background-color: var(--control-yellow); }
        .green { background-color: var(--control-green); }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color-primary);
            font-size: 13px;
            font-weight: 500;
        }
        .user-info .status-dot { width: 8px; height: 8px; background-color: var(--canda-green-dot); border-radius: 50%; }
        .user-info .user-icon svg { width: 18px; height: 18px; stroke: var(--icon-color-primary); stroke-width: 1.5px; } /* Lucide uses stroke */

        .tab-bar {
            display: flex;
            align-items: flex-end;
            background-color: var(--tab-bar-bg);
            padding: 0 8px;
            height: 38px;
            flex-shrink: 0;
            overflow-x: auto;
        }
        .tabs-list { display: flex; list-style: none; margin: 0; padding: 0; height: 100%; align-items: flex-end; }

        .tab {
            display: flex;
            align-items: center;
            padding: 0 12px; /* Generous padding */
            height: 32px; 
            line-height: 32px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 1px;
            border: 1px solid transparent; /* Base border */
            border-bottom: none; /* No bottom border by default */
            max-width: 220px;
            position: relative; /* For z-index and connection */
        }

        .tab.inactive-tab {
            background-color: var(--inactive-tab-bg);
            color: var(--text-color-secondary);
            border-color: #202020; /* Darker border for inactive tabs */
        }
        .tab.inactive-tab:hover { background-color: #383838; }
        .tab.inactive-tab .tab-icon svg { stroke: var(--icon-color-secondary); }
        .tab.inactive-tab .close-tab-btn svg { stroke: var(--icon-color-secondary); }

        .tab.active-tab {
            background-color: var(--active-tab-bg); /* Match editor background */
            color: var(--text-color-primary);
            height: 34px; /* Slightly taller */
            line-height: 34px;
            z-index: 2; /* Above inactive tabs */
            border-color: var(--active-tab-bg); /* Blend with editor */
        }
        .tab.active-tab .tab-icon svg { stroke: var(--text-color-primary); }
        .tab.active-tab .close-tab-btn svg { stroke: var(--text-color-primary); }


        .tab-icon svg { width: 15px; height: 15px; margin-right: 7px; stroke-width: 2; } /* Lucide default stroke */
        .tab-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; }
        
        .tab-title-input {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-color-primary);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 3px;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            padding: 2px 4px;
            margin: 0;
            width: calc(100% - 8px); /* Adjust width considering padding */
        }

        .close-tab-btn {
            background: none; border: none; cursor: pointer;
            padding: 0 2px; margin-left: auto; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; opacity: 0.7;
        }
        .close-tab-btn:hover { background-color: rgba(255,255,255,0.15); opacity: 1; }
        .close-tab-btn svg { width: 14px; height: 14px; stroke-width: 2.5; } /* Bolder X */

        .add-tab-btn {
            background: none; border: none; cursor: pointer;
            padding: 0 8px; margin-left: 5px; display: flex; align-items: center; justify-content: center;
            height: 30px; align-self: center; /* Vertically center */
            color: var(--text-color-secondary);
        }
        .add-tab-btn:hover { color: var(--icon-hover-color); }
        .add-tab-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; }

        .editor-container { flex-grow: 1; background-color: var(--editor-bg); overflow: hidden; position: relative; }
        #monaco-editor { width: 100%; height: 100%; }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--status-bar-bg);
            padding: 3px 12px; height: 22px; flex-shrink: 0;
            border-top: 1px solid #3a3a3a; /* Subtle separator */
        }
        .status-bar-left, .status-bar-right { display: flex; align-items: center; gap: 14px; }
        .status-bar-icon { display: flex; align-items: center; color: var(--icon-color-primary); cursor: pointer; }
        .status-bar-icon:hover { color: var(--icon-hover-color); }
        .status-bar-icon svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 1.5; }
        .status-bar-icon.play-icon svg { fill: currentColor; } /* Make play icon filled */

        /* Scrollbar styling (WebKit) */
        .tab-bar::-webkit-scrollbar { height: 4px; }
        .tab-bar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px;}
        .tab-bar::-webkit-scrollbar-track { background: var(--tab-bar-bg); }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="app-container">
            <div class="title-bar">
                <div class="window-controls">
                    <div class="control-dot red"></div>
                    <div class="control-dot yellow"></div>
                    <div class="control-dot green"></div>
                </div>
                <div class="user-info">
                    <div class="status-dot"></div>
                    <span>Canda</span>
                    <div class="user-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                </div>
            </div>

            <div class="tab-bar">
                <ul class="tabs-list" id="tabsList"></ul>
                <button class="add-tab-btn" id="addTabBtn" title="New Tab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                </button>
            </div>

            <div class="editor-container">
                <div id="monaco-editor"></div>
            </div>

            <div class="status-bar">
                <div class="status-bar-left">
                    <div class="status-bar-icon play-icon" title="Run">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3" fill="currentColor" stroke="currentColor"/></svg>
                    </div>
                    <div class="status-bar-icon" title="Source Control">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><path d="M18 9v3c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"/><path d="M12 12v3"/></svg>
                    </div>
                </div>
                <div class="status-bar-right">
                    <div class="status-bar-icon" title="Problems">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                    </div>
                    <div class="status-bar-icon" title="Explorer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>
                    </div>
                    <div class="status-bar-icon" title="Outline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                    </div>
                    <div class="status-bar-icon" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/vs/loader.js"></script>
    <script>
        let editor;
        let tabs = [];
        let activeTabId = null;
        let nextTabId = 1;

        const tabsListElement = document.getElementById('tabsList');
        const addTabBtn = document.getElementById('addTabBtn');
        const monacoEditorElement = document.getElementById('monaco-editor');

        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/vs' }});
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };
        let proxy = URL.createObjectURL(new Blob([`
            self.MonacoEnvironment = { baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/' };
            importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/vs/base/worker/workerMain.js');
        `], { type: 'text/javascript' }));

        require(["vs/editor/editor.main"], function () {
            // Define custom theme for Monaco to get green Lua strings
            monaco.editor.defineTheme('myCustomDarkTheme', {
                base: 'vs-dark', // Inherit from vs-dark
                inherit: true,
                rules: [
                    { token: 'string.lua', foreground: 'var(--lua-string-color)', fontStyle: 'normal' },
                    // You can add more rules here for other tokens if needed
                    // Example: { token: 'keyword.lua', foreground: '569CD6' },
                ],
                colors: {
                    'editor.background': 'var(--editor-bg)',
                    'editorGutter.background': 'var(--gutter-bg)',
                    'editorLineNumber.foreground': 'var(--line-number-color)',
                    // Ensure minimap background matches
                    'editorOverviewRuler.background': 'var(--editor-bg)', 
                    'minimap.background': 'var(--editor-bg)',
                }
            });
            
            // Apply the custom theme by fetching CSS variable values
            // This needs to be done carefully as Monaco doesn't directly parse CSS vars in theme definitions
            // For simplicity, I'll hardcode the critical ones here, but ideally, you'd fetch them.
             monaco.editor.defineTheme('myFinalTheme', {
                base: 'vs-dark', 
                inherit: true,
                rules: [
                    { token: 'string.lua', foreground: '4EC9B0' }, // Hardcoded green for Lua strings
                    { token: 'keyword.lua', foreground: '569CD6' }, // Example blue for keywords
                    { token: 'identifier.lua', foreground: '9CDCFE' }, // Example for variables/identifiers
                     { token: 'comment.lua', foreground: '6A9955' }, // Green for comments
                ],
                colors: {
                    'editor.background': '#1E1E1E',
                    'editorGutter.background': '#1E1E1E',
                    'editorLineNumber.foreground': '#858585',
                    'minimap.background': '#1E1E1E', 
                    'editorOverviewRuler.border': '#00000000', // Remove minimap border if any
                }
            });

            editor = monaco.editor.create(monacoEditorElement, {
                language: 'lua',
                theme: 'myFinalTheme', // Use the custom theme
                minimap: { enabled: true, showSlider: 'mouseover' },
                automaticLayout: true,
                glyphMargin: true,
                lineNumbersMinChars: 3,
                fontFamily: "var(--editor-font-family)",
                fontSize: 14,
                scrollbar: {
                    verticalScrollbarSize: 10,
                    horizontalScrollbarSize: 10,
                    arrowSize: 10,
                    useShadows: false, // Cleaner look
                },
                padding: { top: 5, bottom: 5} // Small padding inside editor
            });

            // Only one starting tab
            createNewTab("Untitled", `local function greet(name)
    -- This is a Lua comment
    local message = "Hello, " .. name .. "!"
    print(message) -- Output: Hello, [name]!
    return message
end

greet("User")
`); 
            setActiveTab(tabs[0].id);

            editor.onDidChangeModelContent(() => {
                updateTabContent();
            });
        });

        function createNewTab(title = "Untitled", content = "") {
            const tabId = `tab-${nextTabId++}`;
            const newTab = { id: tabId, title: title, content: content, viewState: null };
            tabs.push(newTab);
            renderTabs();
            setActiveTab(tabId);
            return newTab;
        }

        function closeTab(tabIdToClose) {
            const tabIndex = tabs.findIndex(tab => tab.id === tabIdToClose);
            if (tabIndex === -1) return;
            tabs.splice(tabIndex, 1);

            if (activeTabId === tabIdToClose) {
                activeTabId = null;
                if (tabs.length > 0) {
                    const newActiveIndex = Math.max(0, tabIndex - 1);
                    setActiveTab(tabs[newActiveIndex].id);
                } else {
                    if (editor) editor.setValue("");
                    // Optionally: createNewTab(); // If you always want at least one tab
                }
            }
            renderTabs();
            if (tabs.length === 0 && editor) { editor.setValue(''); }
        }

        function setActiveTab(tabId) {
            if (activeTabId && editor) {
                const currentActiveTabData = tabs.find(tab => tab.id === activeTabId);
                if (currentActiveTabData) currentActiveTabData.viewState = editor.saveViewState();
            }
            activeTabId = tabId;
            const newActiveTabData = tabs.find(tab => tab.id === tabId);

            if (newActiveTabData && editor) {
                editor.setValue(newActiveTabData.content);
                if (newActiveTabData.viewState) editor.restoreViewState(newActiveTabData.viewState);
                editor.focus();
            } else if (!newActiveTabData && editor) {
                editor.setValue("");
            }
            renderTabs();
        }

        function updateTabContent() {
            if (!activeTabId || !editor) return;
            const activeTabData = tabs.find(tab => tab.id === activeTabId);
            if (activeTabData) activeTabData.content = editor.getValue();
        }

        function renderTabs() {
            tabsListElement.innerHTML = '';
            tabs.forEach(tabData => {
                const tabElement = document.createElement('li');
                tabElement.className = 'tab';
                if (tabData.id === activeTabId) {
                    tabElement.classList.add('active-tab');
                } else {
                    tabElement.classList.add('inactive-tab');
                }
                tabElement.dataset.tabId = tabData.id;

                const iconElement = document.createElement('span');
                iconElement.className = 'tab-icon';
                iconElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>`; // Lucide file-text

                const titleSpan = document.createElement('span');
                titleSpan.className = 'tab-title';
                titleSpan.textContent = tabData.title;

                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-tab-btn';
                closeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>`; // Lucide x
                closeBtn.title = "Close Tab";
                closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeTab(tabData.id); });

                tabElement.appendChild(iconElement);
                tabElement.appendChild(titleSpan);
                tabElement.appendChild(closeBtn);
                tabElement.addEventListener('click', () => setActiveTab(tabData.id));

                titleSpan.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const currentTitle = tabData.title;
                    titleSpan.innerHTML = ''; 
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentTitle;
                    input.className = 'tab-title-input';
                    
                    const tempSpan = document.createElement('span'); // For width calculation
                    tempSpan.style.fontFamily = getComputedStyle(titleSpan).fontFamily;
                    tempSpan.style.fontSize = getComputedStyle(titleSpan).fontSize;
                    tempSpan.style.visibility = 'hidden';
                    tempSpan.style.position = 'absolute';
                    tempSpan.textContent = currentTitle;
                    document.body.appendChild(tempSpan);
                    input.style.width = Math.max(50, tempSpan.offsetWidth + 10) + 'px';
                    document.body.removeChild(tempSpan);

                    const finishRename = () => {
                        const newTitle = input.value.trim();
                        if (newTitle) tabData.title = newTitle;
                        else tabData.title = "Untitled"; // Default if empty
                        
                        if (input.parentNode === titleSpan) titleSpan.removeChild(input);
                        titleSpan.textContent = tabData.title; // Set text directly back
                        // No full renderTabs() here to avoid losing focus if user is quick
                        // but if styles depend on it, a full render might be needed, or more targeted updates.
                        // For now, let's see if this is sufficient.
                        // If titles are used in other places, a full state update/re-render might be better.
                        // Let's re-render to ensure consistency.
                        renderTabs(); 
                        // Try to re-focus the newly rendered active tab's title for chaining renames, though this is tricky.
                        const newActiveTabElement = tabsListElement.querySelector(`.tab[data-tab-id="${activeTabId}"] .tab-title`);
                        // if (newActiveTabElement) newActiveTabElement.focus(); // Might not work as expected
                    };

                    input.addEventListener('blur', finishRename);
                    input.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') input.blur(); // Trigger blur to finish
                        else if (event.key === 'Escape') { input.value = currentTitle; input.blur(); }
                    });
                    titleSpan.appendChild(input);
                    input.focus(); input.select();
                });
                tabsListElement.appendChild(tabElement);
            });
        }

        addTabBtn.addEventListener('click', () => createNewTab("Untitled", "// New Lua Script\n"));

    </script>
</body>
</html>
